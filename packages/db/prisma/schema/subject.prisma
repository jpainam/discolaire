model Subject {
    id                Int                @id @default(autoincrement())
    courseId          String
    teacherId         String?
    classroomId       String
    subjectGroupId    Int?
    program           String?
    order             Int                @default(1)
    coefficient       Float              @default(1)
    gradeSheets       GradeSheet[]
    programs          SubjectProgram[]
    classroom         Classroom          @relation(fields: [classroomId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    course            Course             @relation(fields: [courseId], references: [id])
    subjectGroup      SubjectGroup?      @relation(fields: [subjectGroupId], references: [id])
    teacher           Staff?             @relation(fields: [teacherId], references: [id])
    assignments       Assignment[]
    timetables        SubjectTimetable[]
    skillAcquisitions SkillAcquisition[]

    @@unique([courseId, teacherId, classroomId])
}

model SubjectGroup {
    id       Int       @id @default(autoincrement())
    name     String
    subjects Subject[]
    school   School    @relation(fields: [schoolId], references: [id])
    schoolId String
}

model Course {
    id         String    @id @default(uuid())
    name       String
    color      String
    createdAt  DateTime  @default(now()) @db.Timestamp(6)
    updatedAt  DateTime  @updatedAt
    shortName  String
    reportName String
    isActive   Boolean   @default(true)
    subjects   Subject[]
    school     School    @relation(fields: [schoolId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    schoolId   String
}

enum PriorityEnum {
    URGENT
    HIGH
    MEDIUM
    LOW
}

model SubjectTimetable {
    id          Int            @id @default(autoincrement())
    weekday     Int // 0=Sun, 1=Mon ... 7=Sa
    start       String
    end         String
    subjectId   Int
    validFrom   DateTime       @default(now()) // when this rule started being true (inclusive)
    validTo     DateTime? // when it stopped (exclusive). null = still active
    category    TimetableGroup @default(SUBJECT)
    subject     Subject        @relation(fields: [subjectId], references: [id], onDelete: Cascade)
    createdById String?
    createdBy   User?          @relation("SubjectTimetableCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

    @@unique([subjectId, weekday, start, end])
    @@index([validFrom])
    @@index([validTo])
}

model SubjectProgram {
    id                   String           @id @default(cuid())
    title                String
    description          String?
    subjectId            Int
    isCompleted          Boolean          @default(false)
    priority             PriorityEnum     @default(MEDIUM)
    requiredSessionCount Int              @default(1)
    startDate            DateTime         @default(now())
    termId               String
    term                 Term             @relation(fields: [termId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    subject              Subject          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
    journals             SubjectJournal[]
    createdAt            DateTime         @default(now())
    updatedAt            DateTime         @updatedAt
    createdById          String
    createdBy            User             @relation("SubjectProgramCreatedBy", fields: [createdById], references: [id])
}

model SubjectJournal {
    id           String         @id @default(cuid())
    subjectId    Int
    title        String
    content      String
    createdById  String
    attachment   String?
    sessionCount Int            @default(1)
    publishDate  DateTime       @default(now()) @db.Timestamp(6)
    createdBy    User           @relation("SubjectJournalCreatedBy", fields: [createdById], references: [id])
    programId    String
    program      SubjectProgram @relation(fields: [programId], references: [id], onDelete: Cascade, onUpdate: Cascade)
    createdAt    DateTime       @default(now())
    updatedAt    DateTime       @updatedAt
}

model SkillAcquisition {
    id          Int      @id @default(autoincrement())
    content     String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    createdById String
    createdBy   User     @relation("SkillAcquisitionCreatedBy", fields: [createdById], references: [id])
    subjectId   Int
    subject     Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
    termId      String
    term        Term     @relation(fields: [termId], references: [id], onDelete: Cascade)

    @@unique([termId, subjectId])
}
